<script type="text/javascript">
    // La URL del modelo apunta a tu carpeta en GitHub Pages
    const URL = "./my_model/"; 

    let model, webcam, labelContainer, maxPredictions;
    let modelLoaded = false;
    let animationFrameId;

    // Cargar el modelo (solo una vez)
    async function loadModel() {
        if (modelLoaded) return;

        labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = 'Cargando modelo y metadatos...';

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        try {
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            modelLoaded = true;
            labelContainer.innerHTML = 'Modelo cargado con √©xito. Listo.';
        } catch (error) {
            labelContainer.innerHTML = "<span class='danger'>ERROR: No se pudo cargar el modelo. Verifica tu ruta.</span>";
            console.error("Fallo al cargar el modelo:", error);
            throw error;
        }
    }

    // Inicializar la c√°mara trasera
    async function init() {
        await loadModel();

        try {
            // Detener cualquier c√°mara anterior
            if (animationFrameId) window.cancelAnimationFrame(animationFrameId);
            if (webcam && webcam.running) webcam.stop();
            document.getElementById("webcam-container").innerHTML = '';

            const flip = false; // No voltear imagen (ideal para trasera)
            webcam = new tmImage.Webcam(200, 200, flip);

            // ‚ö° PASO CLAVE: especificar la c√°mara trasera aqu√≠
            await webcam.setup({ facingMode: "environment" });
            await webcam.play();

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            document.getElementById("cam-button").disabled = true;

            loop(); 
            labelContainer.innerHTML = 'C√°mara activa (trasera). ¬°Enfoca la seta!';

        } catch (e) {
            console.error("Error al iniciar c√°mara trasera:", e);
            labelContainer.innerHTML = '<span class="danger">No se pudo usar la c√°mara trasera. Usando c√°mara por defecto.</span>';

            // fallback a c√°mara por defecto
            try {
                webcam = new tmImage.Webcam(200, 200, true);
                await webcam.setup();
                await webcam.play();
                document.getElementById("webcam-container").appendChild(webcam.canvas);
                loop();
            } catch (e2) {
                labelContainer.innerHTML = '<span class="danger">ERROR: La c√°mara no est√° disponible.</span>';
                document.getElementById("cam-button").disabled = true;
            }
        }
    }

    // Bucle de predicci√≥n
    async function loop() {
        webcam.update();
        await predict(webcam.canvas);
        animationFrameId = window.requestAnimationFrame(loop);
    }

    // Manejo de subida de archivos
    async function handleFileUpload(event) {
        await loadModel();

        // Detener la c√°mara si estaba activa
        if (webcam && webcam.running) {
            webcam.stop();
            if (animationFrameId) window.cancelAnimationFrame(animationFrameId);
            document.getElementById("cam-button").disabled = false;
        }

        const file = event.target.files[0];
        if (!file) return;

        const img = new Image();
        img.onload = async () => {
            const container = document.getElementById("webcam-container");
            container.innerHTML = '';
            img.style.width = '200px';
            img.style.height = '200px';
            container.appendChild(img);

            await predict(img);
        };
        img.src = URL.createObjectURL(file);
    }

    // Funci√≥n de predicci√≥n
    async function predict(imageElement) {
        try {
            const prediction = await model.predict(imageElement);

            let highestPrediction = { className: "Desconocido", probability: 0 };

            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > highestPrediction.probability) {
                    highestPrediction = prediction[i];
                }
            }

            const probabilityPercent = (highestPrediction.probability * 100).toFixed(2);
            let resultHTML = `CLASIFICACI√ìN: <b>${highestPrediction.className}</b>`;
            resultHTML += `<br>(Confianza: ${probabilityPercent}%)`;

            const normalizedLabel = highestPrediction.className.toLowerCase();

            if (normalizedLabel.includes("falsos rebollones") || normalizedLabel.includes("no comestible")) {
                resultHTML += "<br><span class='danger'>üö® ¬°PELIGRO! Evite el consumo.</span>";
            } else if (normalizedLabel.includes("rebollon")) {
                resultHTML += "<br><span class='success'>‚úÖ ¬°Parece un Reboll√≥n! (Consulte a un experto)</span>";
            }

            labelContainer.innerHTML = resultHTML;

        } catch (e) {
            labelContainer.innerHTML = "<span class='danger'>ERROR: Fallo al clasificar. Revisa la consola (F12).</span>";
            console.error("Fallo en la funci√≥n predict.", e);
        }
    }
</script>
