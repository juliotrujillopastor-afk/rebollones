<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clasificador de Setas üçÑ</title>
<style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #webcam-container { margin: 20px auto; width: 200px; height: 200px; border: 1px solid #ccc; }
    video { width: 200px; height: 200px; object-fit: cover; }
    .danger { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
</style>
</head>
<body>
<h1>Clasificador de Setas</h1>

<div id="controls">
    <button type="button" onclick="init()" id="cam-button">Iniciar C√°mara (Trasera)</button>
    <input type="file" id="file-upload" accept="image/*" onchange="handleFileUpload(event)">
    <p>O sube una imagen.</p>
</div>

<div id="webcam-container"></div>
<div id="label-container">Carga el modelo y presiona "Iniciar C√°mara" o sube una imagen.</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<script>
const URL = "./my_model/";

let model, maxPredictions;
let animationFrameId;
let video;

async function loadModel() {
    const labelContainer = document.getElementById("label-container");
    labelContainer.innerHTML = 'Cargando modelo...';
    model = await tmImage.load(URL + "model.json", URL + "metadata.json");
    maxPredictions = model.getTotalClasses();
    labelContainer.innerHTML = 'Modelo cargado con √©xito.';
}

async function init() {
    await loadModel();
    const container = document.getElementById("webcam-container");
    container.innerHTML = '';

    video = document.createElement("video");
    video.setAttribute("autoplay", "");
    video.setAttribute("playsinline", ""); // obligatorio en iOS
    video.width = 200;
    video.height = 200;
    container.appendChild(video);

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            video.play();
            loop();
            document.getElementById("cam-button").disabled = true;
            document.getElementById("label-container").innerHTML = 'C√°mara trasera activa. ¬°Enfoca la seta!';
        };
    } catch (err) {
        console.error(err);
        document.getElementById("label-container").innerHTML = '<span class="danger">No se pudo acceder a la c√°mara trasera.</span>';
    }
}

async function loop() {
    await predict(video);
    animationFrameId = requestAnimationFrame(loop);
}

async function handleFileUpload(event) {
    await loadModel();
    if (video) video.pause();

    const file = event.target.files[0];
    if (!file) return;

    const img = new Image();
    img.onload = async () => {
        const container = document.getElementById("webcam-container");
        container.innerHTML = '';
        img.width = 200;
        img.height = 200;
        container.appendChild(img);
        await predict(img);
    };
    img.src = URL.createObjectURL(file);
}

async function predict(element) {
    try {
        const prediction = await model.predict(element);
        let highest = { className: "Desconocido", probability: 0 };
        for (let i = 0; i < maxPredictions; i++) {
            if (prediction[i].probability > highest.probability) highest = prediction[i];
        }
        const prob = (highest.probability * 100).toFixed(2);
        let resultHTML = `CLASIFICACI√ìN: <b>${highest.className}</b><br>(Confianza: ${prob}%)`;
        const label = highest.className.toLowerCase();
        if (label.includes("falsos rebollones") || label.includes("no comestible")) resultHTML += "<br><span class='danger'>üö® ¬°PELIGRO! Evite el consumo.</span>";
        else if (label.includes("rebollon")) resultHTML += "<br><span class='success'>‚úÖ ¬°Parece un Reboll√≥n! (Consulte a un experto)</span>";
        document.getElementById("label-container").innerHTML = resultHTML;
    } catch (e) {
        console.error(e);
        document.getElementById("label-container").innerHTML = "<span class='danger'>ERROR al clasificar.</span>";
    }
}
</script>
</body>
</html>
