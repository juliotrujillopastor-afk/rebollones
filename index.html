<script type="text/javascript">
    // **Ruta de la carpeta local donde est√°n los 3 archivos**
    const URL = "./my_model/"; 

    let model, webcam, labelContainer, maxPredictions;
    let modelLoaded = false;
    let animationFrameId; // Para manejar el bucle de la c√°mara

    // Funci√≥n para cargar el modelo (solo una vez)
    async function loadModel() {
        if (modelLoaded) return;
        
        labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = 'Cargando modelo y metadatos... (Esto puede tardar)';
        console.log("1. Intentando cargar el modelo desde:", URL);

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        try {
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            modelLoaded = true;
            labelContainer.innerHTML = 'Modelo cargado con √©xito. Listo.';
            console.log("2. Modelo cargado con √©xito. Clases:", maxPredictions);
        } catch (error) {
            labelContainer.innerHTML = "<span class='danger'>ERROR: No se pudo cargar el modelo. Revisa la consola (F12).</span>";
            console.error("ERROR 1: Fallo cr√≠tico al cargar el modelo.", error);
            throw error;
        }
    }


    // **INIT**: Inicia la c√°mara
    async function init(useWebcam) {
        try {
            await loadModel(); 

            if (!useWebcam) return; 
            
            // Detener el bucle anterior si existe
            if (animationFrameId) window.cancelAnimationFrame(animationFrameId);
            if (webcam && webcam.running) webcam.stop();

            document.getElementById("webcam-container").innerHTML = ''; 

            console.log("3. Configurando la c√°mara.");
            const flip = true; 
            webcam = new tmImage.Webcam(200, 200, flip);
            await webcam.setup(); 
            await webcam.play();
            
            document.getElementById("webcam-container").appendChild(webcam.canvas);
            document.getElementById("cam-button").disabled = true;
            labelContainer.innerHTML = '¬°Enfoca la seta! (C√°mara activa)';
            
            // Iniciar el bucle de clasificaci√≥n
            console.log("4. Iniciando el bucle de clasificaci√≥n de c√°mara.");
            loop(); // Llamamos a loop sin requestAnimationFrame inicialmente
        } catch (e) {
            console.error("ERROR 2: Fallo en la inicializaci√≥n de la c√°mara.", e);
        }
    }

    // **LOOP** (Solo para c√°mara)
    async function loop() {
        webcam.update(); 
        await predict(webcam.canvas);
        // Volver a llamar a loop usando requestAnimationFrame para el siguiente frame
        animationFrameId = window.requestAnimationFrame(loop); 
    }
    
    // **MANEJO DE SUBIDA DE IMAGEN**
    async function handleImageUpload(event) {
        try {
            await loadModel();

            const file = event.target.files[0];
            if (!file) return;

            // Detenemos la c√°mara si estaba activa
            if (webcam && webcam.running) {
                webcam.stop();
                if (animationFrameId) window.cancelAnimationFrame(animationFrameId);
                document.getElementById("cam-button").disabled = false;
            }

            // Muestra la imagen subida
            const img = new Image();
            img.onload = async () => {
                console.log("5. Imagen cargada en el DOM. Iniciando predicci√≥n...");
                const container = document.getElementById("webcam-container");
                container.innerHTML = ''; 
                img.style.maxWidth = '100%'; 
                img.style.height = 'auto';
                container.appendChild(img);
                
                // La llamada a predict con la imagen es CR√çTICA
                await predict(img);
            };
            img.src = URL.createObjectURL(file);
        } catch (e) {
             console.error("ERROR 3: Fallo en la subida de imagen.", e);
        }
    }

    // **PREDICT**: Funci√≥n principal de clasificaci√≥n
    async function predict(imageElement) {
        try {
            // Aseguramos que el elemento sea un canvas/imagen v√°lido.
            if (!imageElement) return; 
            
            const prediction = await model.predict(imageElement, false);
            
            let highestPrediction = { className: "Desconocido", probability: 0, originalIndex: -1 };

            // 1. Encontrar la clase con mayor probabilidad
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i];
                if (classPrediction.probability > highestPrediction.probability) {
                    highestPrediction = {
                        className: classPrediction.className,
                        probability: classPrediction.probability,
                        originalIndex: i
                    };
                }
            }
            
            // 2. Obtener las etiquetas del modelo
            const labels = model.getClassLabels();
            const predictedLabel = labels[highestPrediction.originalIndex];

            // 3. Mostrar el resultado
            const probabilityPercent = (highestPrediction.probability * 100).toFixed(2);
            let resultHTML = `<div class="result-title">CLASIFICACI√ìN: ${predictedLabel}</div>`;
            resultHTML += `<div>(Confianza: ${probabilityPercent}%)</div>`;
            
            // 4. Advertencia de seguridad
            const normalizedLabel = predictedLabel.toLowerCase();
            
            if (normalizedLabel.includes("falsos rebollones") || normalizedLabel.includes("no comestible")) {
                resultHTML += "<br><span class='danger'>üö® ¬°PELIGRO! Evite el consumo.</span>";
            } else if (normalizedLabel.includes("rebollon")) {
                resultHTML += "<br><span class='success'>‚úÖ ¬°Parece un Reboll√≥n! (Consulte siempre a un experto)</span>";
            }
            
            labelContainer.innerHTML = resultHTML;
            console.log("6. Predicci√≥n exitosa. Resultado mostrado:", predictedLabel);

        } catch (e) {
            labelContainer.innerHTML = "<span class='danger'>ERROR: Fallo al clasificar la imagen. Revisa la consola (F12).</span>";
            console.error("ERROR 4: Fallo en la funci√≥n predict.", e);
        }
    }
</script>
    </script>
</body>

</html>
